name: CI

on:

  push:

    branches: [ "main", "develop" ]

  pull_request:

    branches: [ "main", "develop" ]

jobs:

  build:

    runs-on: ubuntu-latest

    services:

      postgres:

        image: postgres:15

        env:

          POSTGRES_USER: sincov_user

          POSTGRES_PASSWORD: testpass123

          POSTGRES_DB: sincov_db

        ports:

          - 5432:5432

        options: >-

          --health-cmd "pg_isready -U sincov_user -d sincov_db"

          --health-interval 5s

          --health-timeout 5s

          --health-retries 5

    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

      - name: Set up Python

        uses: actions/setup-python@v5

        with:

          python-version: "3.12"

      - name: Install dependencies

        run: |

          python -m pip install --upgrade pip

          pip install -r requirements.txt

      - name: Wait for PostgreSQL to be ready

        run: |

          for i in {1..10}; do

            pg_isready -h localhost -p 5432 -U sincov_user && break

            echo "Waiting for Postgres..."

            sleep 2

          done

      - name: Run tests

        env:

          DATABASE_URL: postgresql+psycopg2://sincov_user:testpass123@localhost:5432/sincov_db

        run: |

          export PYTHONPATH=$PWD

          pytest -v